{% extends 'base.html' %}
{% load static %}
{% load cart_tags %}
{% load cart_filters %}

{% block title %}Carrito - E-Commerce{% endblock %}

{% block content %}
<div class="container cart-container my-5">
    <h2 class="mb-4">Tu Carrito</h2>
    {% if cart_items %}
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title mb-4"><i class="fas fa-truck me-2"></i>Método de envío</h5>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="shipping_method" id="free_shipping" value="free" checked>
                    <label class="form-check-label d-flex justify-content-between align-items-center" for="free_shipping">
                        <span>
                            <strong>Envío estándar</strong>
                            <br>
                            <small class="text-muted">Entrega en 3-5 días laborables</small>
                        </span>
                        <span class="badge bg-success">Gratis</span>
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="shipping_method" id="express_shipping" value="express">
                    <label class="form-check-label d-flex justify-content-between align-items-center" for="express_shipping">
                        <span>
                            <strong>Envío express</strong>
                            <br>
                            <small class="text-muted">Entrega en 24-48 horas</small>
                        </span>
                        <span class="badge bg-primary">+€4.99</span>
                    </label>
                </div>
            </div>
        </div>

        {% for item in cart_items %}
            <div class="row align-items-center mb-4 py-3 {% if not forloop.last %}border-bottom{% endif %}">
                <div class="col-md-2">
                    {% if item.product.imagen %}
                        <img src="{{ item.product.imagen.url }}" alt="{{ item.product.nombre }}" class="img-fluid rounded">
                    {% else %}
                        <img src="{% static 'images/default-product.jpg' %}" alt="{{ item.product.nombre }}" class="img-fluid rounded">
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <h5><a href="{% url 'product_detail' item.product.id %}" class="text-decoration-none text-dark">{{ item.product.nombre }}</a></h5>
                    <p class="text-muted small mb-0">{{ item.product.descripcion|truncatechars:100 }}</p>
                </div>
                <div class="col-md-2 text-center">
                    <div class="quantity">
                        <span class="fw-bold">Cantidad: {{ item.quantity }}</span>
                    </div>
                </div>
                <div class="col-md-2 text-center">
                    {% if item.product.en_promocion %}
                        <div>
                            <span class="text-decoration-line-through text-muted small">€{{ item.product.precio }}</span>
                            <span class="badge bg-warning text-dark">-{{ item.product.descuento }}%</span>
                            <div class="text-danger fw-bold">€{{ item.product.precio_promocion }}</div>
                        </div>
                    {% else %}
                        <div class="fw-bold">€{{ item.product.precio }}</div>
                    {% endif %}
                </div>
                <div class="col-md-2 text-end">
                    <div class="fw-bold">
                        {% if item.product.en_promocion %}
                            €{{ item.quantity|multiply:item.product.precio_promocion }}
                        {% else %}
                            €{{ item.get_total }}
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
        
        <div class="row mt-4">
            <div class="col-12 text-end">
                <h4>Total: <span class="text-primary">€{{ total }}</span></h4>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-truck me-2"></i>Contrareembolso</h5>
                        <p class="card-text">Paga cuando recibas tu pedido en casa</p>
                        <form action="{% url 'checkout_cod' %}" method="POST">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-money-bill me-2"></i>Pagar al recibir
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-credit-card me-2"></i>Pago con tarjeta</h5>
                        <p class="card-text">Pago seguro con tarjeta de crédito/débito</p>
                        <button type="button" class="btn btn-success w-100" id="checkout-button">
                            <i class="fas fa-lock me-2"></i>Pagar con tarjeta
                        </button>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="text-center py-5">
            <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
            <h3>Tu carrito está vacío</h3>
            <p class="text-muted">¡Añade algunos productos para empezar!</p>
            <a href="{% url 'home' %}" class="btn btn-primary mt-3">
                <i class="fas fa-shopping-bag me-2"></i>Ir a comprar
            </a>
        </div>
    {% endif %}
</div>

<script>
    var stripe = Stripe('{{ STRIPE_PUBLISHABLE_KEY }}');
    var checkoutButton = document.getElementById('checkout-button');
    
    checkoutButton.addEventListener('click', function() {
        checkoutButton.disabled = true;
        // ... resto del código de Stripe ...
    });
</script>
{% endblock %}
